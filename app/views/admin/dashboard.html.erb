<!DOCTYPE html>
<html>
<head>
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #1a1a1a;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab-button {
      padding: 12px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .tab-button:hover {
      color: #4CAF50;
    }

    .tab-button.active {
      color: #4CAF50;
      border-bottom-color: #4CAF50;
      font-weight: 600;
    }

    .date-filter {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .period-buttons {
      display: flex;
      gap: 10px;
    }

    .period-btn {
      padding: 10px 20px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .period-btn:hover {
      border-color: #4CAF50;
      color: #4CAF50;
    }

    .period-btn.active {
      background: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }

    .custom-date {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .custom-date input {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .apply-btn {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .apply-btn:hover {
      background: #45a049;
    }

    .export-btn {
      padding: 10px 20px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: inline-block;
    }

    .export-btn:hover {
      background: #1976D2;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .metric-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
    }

    .metric-value.highlight {
      color: #4CAF50;
    }

    .content-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    h2 {
      font-size: 22px;
      margin-bottom: 20px;
      color: #1a1a1a;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .data-table th {
      background: #f9f9f9;
      font-weight: 600;
      color: #666;
      font-size: 13px;
      text-transform: uppercase;
    }

    .data-table tr:hover {
      background: #f9f9f9;
    }

    .drop-off-bar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bar-container {
      flex: 1;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b6b, #ff8787);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .bar-fill.low {
      background: linear-gradient(90deg, #51cf66, #69db7c);
    }

    .bar-fill.medium {
      background: linear-gradient(90deg, #ffd43b, #ffe066);
    }

    .percentage {
      font-weight: 600;
      min-width: 50px;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    .summary-item {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-question {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 15px;
      color: #1a1a1a;
    }

    .answer-option {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .answer-label {
      min-width: 200px;
      font-size: 14px;
    }

    .answer-bar {
      flex: 1;
      height: 30px;
      background: #f0f0f0;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }

    .answer-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #66BB6A);
      transition: width 0.3s ease;
    }

    .answer-stats {
      min-width: 120px;
      text-align: right;
      font-size: 14px;
      font-weight: 600;
    }

    .responses-table-wrapper {
      overflow-x: auto;
    }

    @media (max-width: 768px) {
      .date-filter {
        flex-direction: column;
        align-items: stretch;
      }

      .period-buttons {
        flex-wrap: wrap;
      }

      .custom-date {
        flex-direction: column;
        align-items: stretch;
      }

      .tabs {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="header">
      <h1>ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      
      <div class="tabs">
        <a href="?tab=insights&period=<%= @period %>&start_date=<%= @start_date %>&end_date=<%= @end_date %>" 
           class="tab-button <%= 'active' if @tab == 'insights' %>">ì¸ì‚¬ì´íŠ¸</a>
        <a href="?tab=summary&period=<%= @period %>&start_date=<%= @start_date %>&end_date=<%= @end_date %>" 
           class="tab-button <%= 'active' if @tab == 'summary' %>">ìš”ì•½</a>
        <a href="?tab=responses&period=<%= @period %>&start_date=<%= @start_date %>&end_date=<%= @end_date %>" 
           class="tab-button <%= 'active' if @tab == 'responses' %>">ì‘ë‹µ</a>
      </div>
      
      <form class="date-filter" method="get" action="/admin/dashboard">
        <input type="hidden" name="tab" value="<%= @tab %>">
        <div class="period-buttons">
          <button type="submit" name="period" value="today" class="period-btn <%= 'active' if @period == 'today' %>">ì˜¤ëŠ˜</button>
          <button type="submit" name="period" value="week" class="period-btn <%= 'active' if @period == 'week' %>">ì´ë²ˆì£¼</button>
          <button type="submit" name="period" value="month" class="period-btn <%= 'active' if @period == 'month' %>">ì´ë²ˆë‹¬</button>
        </div>
        
        <div class="custom-date">
          <input type="date" name="start_date" value="<%= @start_date %>" required>
          <span>~</span>
          <input type="date" name="end_date" value="<%= @end_date %>" required>
          <button type="submit" name="period" value="custom" class="apply-btn">ì ìš©</button>
        </div>
        
        <% if @tab == 'responses' %>
          <a href="/admin/export_responses.csv?period=<%= @period %>&start_date=<%= @start_date %>&end_date=<%= @end_date %>" 
             class="export-btn">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
        <% end %>
      </form>
    </div>

    <% if @tab == 'insights' %>
      <div class="content-section">
        <h2>ğŸ“ˆ ì¸ì‚¬ì´íŠ¸</h2>
        
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">ì‚¬ì´íŠ¸ ì¡°íšŒìˆ˜</div>
            <div class="metric-value"><%= @page_views %></div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ìˆœë°©ë¬¸ììˆ˜</div>
            <div class="metric-value"><%= @unique_visitors %></div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ì‹œì‘ë²„íŠ¼ ëˆ„ë¥¸ ì‚¬ëŒìˆ˜</div>
            <div class="metric-value"><%= @start_clicks %></div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ê²°ê³¼í™”ë©´ ë„ë‹¬ ì‚¬ëŒìˆ˜</div>
            <div class="metric-value"><%= @result_views %></div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ê²°ê³¼í™”ë©´ ë²„íŠ¼ í´ë¦­ìˆ˜</div>
            <div class="metric-value"><%= @result_clicks %></div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ë‹¨ì¶• ë°©ë²• ë³´ê¸° í´ë¦­</div>
            <div class="metric-value"><%= @reveal_clicks %></div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ìŠ¤í‹°í‚¤ë°” CTA í´ë¦­</div>
            <div class="metric-value"><%= @sticky_cta_clicks %></div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ì„¤ë¬¸ ì™„ë£Œ ì „í™˜ìœ¨</div>
            <div class="metric-value highlight"><%= @conversion_rate %>%</div>
          </div>
        </div>
      </div>

      <div class="content-section">
        <h2>ğŸ“‰ ì§ˆë¬¸ë³„ ì´íƒˆë¥  & ì²´ë¥˜ì‹œê°„</h2>
        
        <% if @drop_off_by_question.any? %>
          <table class="data-table">
            <thead>
              <tr>
                <th>ì§ˆë¬¸</th>
                <th>ì¡°íšŒìˆ˜</th>
                <th>í‰ê·  ì²´ë¥˜ì‹œê°„</th>
                <th>ì´íƒˆë¥ </th>
              </tr>
            </thead>
            <tbody>
              <% @drop_off_by_question.each do |question_num, data| %>
                <tr>
                  <td>
                    <div style="font-weight: 600; margin-bottom: 4px;">ì§ˆë¬¸ <%= question_num %></div>
                    <div style="font-size: 13px; color: #666;"><%= @question_titles[question_num] %></div>
                  </td>
                  <td><%= data[:viewed] %></td>
                  <td>
                    <% if @avg_duration_by_question[question_num][:count] > 0 %>
                      <span style="font-weight: 600;"><%= @avg_duration_by_question[question_num][:average] %>ì´ˆ</span>
                      <span style="font-size: 12px; color: #999;"> (n=<%= @avg_duration_by_question[question_num][:count] %>)</span>
                    <% else %>
                      <span style="color: #999;">-</span>
                    <% end %>
                  </td>
                  <td>
                    <div class="drop-off-bar">
                      <div class="bar-container">
                        <% 
                          bar_class = if data[:drop_off] < 10
                            'low'
                          elsif data[:drop_off] < 30
                            'medium'
                          else
                            ''
                          end
                        %>
                        <div class="bar-fill <%= bar_class %>" style="width: <%= [data[:drop_off], 100].min %>%"></div>
                      </div>
                      <span class="percentage"><%= data[:drop_off] %>%</span>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="no-data">
            ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        <% end %>
      </div>

    <% elsif @tab == 'summary' %>
      <div class="content-section">
        <h2>ğŸ“Š ë‹µë³€ ìš”ì•½</h2>
        
        <% if @answer_summary.any? %>
          <% (3..10).each do |q| %>
            <% if @answer_summary[q] && @answer_summary[q].any? %>
              <div class="summary-item">
                <div class="summary-question">
                  ì§ˆë¬¸ <%= q %>: <%= @question_titles[q] %>
                </div>
                <% @answer_summary[q].each do |answer_data| %>
                  <div class="answer-option">
                    <div class="answer-label">
                      <%= @answer_labels.dig(q, answer_data[:answer]) || answer_data[:answer] || '(ì‘ë‹µ ì—†ìŒ)' %>
                    </div>
                    <div class="answer-bar">
                      <div class="answer-bar-fill" style="width: <%= answer_data[:percentage] %>%"></div>
                    </div>
                    <div class="answer-stats">
                      <%= answer_data[:count] %>ëª… (<%= answer_data[:percentage] %>%)
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        <% else %>
          <div class="no-data">
            ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        <% end %>
      </div>

    <% elsif @tab == 'responses' %>
      <div class="content-section">
        <h2>ğŸ“‹ ì‘ë‹µ ë°ì´í„°</h2>
        
        <% if @responses.any? %>
          <div class="responses-table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ì™„ë£Œ ì‹œê°„ (í•œêµ­ì‹œê°„)</th>
                  <th>ì„¸ì…˜ ID</th>
                  <% (3..10).each do |q| %>
                    <th>Q<%= q %></th>
                  <% end %>
                </tr>
              </thead>
              <tbody>
                <% @responses.each do |response| %>
                  <tr>
                    <td><%= response[:completed_at].in_time_zone('Seoul').strftime('%Y-%m-%d %H:%M:%S') %></td>
                    <td style="font-family: monospace; font-size: 11px; color: #666;"><%= response[:session_id][0..12] %>...</td>
                    <% (3..10).each do |q| %>
                      <td><%= @answer_labels.dig(q, response[:answers][q]) || response[:answers][q] || '-' %></td>
                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="no-data">
            ì„ íƒí•œ ê¸°ê°„ì— ì™„ë£Œëœ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</body>
</html>
